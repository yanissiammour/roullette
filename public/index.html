<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Roulette Europ√©enne Multijoueur - Social</title>
<script src="/socket.io/socket.io.js"></script>
<style>
/* ‚îÄ‚îÄ STYLE D'ORIGINE CONSERV√â ‚îÄ‚îÄ */
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #0a5028; min-height: 100vh; font-family: monospace; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
h1 { color: #f0d080; font-size: 1.05rem; letter-spacing: 0.22em; padding: 10px 0 7px; text-align: center; width: 100%; border-bottom: 1px solid rgba(240,208,128,0.2); flex-shrink: 0; }

#startScreen { position: fixed; inset: 0; background: rgba(5,35,15,0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; z-index: 100; }
#startScreen h2 { color: #f0d080; font-size: 1.3rem; letter-spacing: 0.2em; }
.start-input { width: 220px; padding: 10px; font-size: 1.2rem; font-family: monospace; border: 2px solid #f0d080; background: #0a3520; color: #f0d080; text-align: center; outline: none; }
.gold-btn { padding: 10px 36px; font-size: 1rem; font-family: monospace; background: #f0d080; border: none; color: #000; cursor: pointer; font-weight: bold; letter-spacing: 0.12em; transition: 0.2s; touch-action: manipulation; }
.gold-btn:hover { background: #fff; }
.gold-btn:disabled { opacity: 0.35; cursor: default; }

/* ‚îÄ‚îÄ LAYOUT 3 COLONNES ‚îÄ‚îÄ */
#game { display: none; grid-template-columns: 440px 1fr 300px; width: 100vw; height: calc(100vh - 42px); }

.left-panel { border-right: 1px solid rgba(240,208,128,0.2); display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-y: auto; }
canvas { display: block; margin-bottom: 10px; }
#historyList { width: 100%; }
.history-item { background: rgba(0,0,0,0.2); border: 1px solid rgba(240,208,128,0.2); margin-bottom: 10px; padding: 8px; font-size: 0.75rem; border-radius: 4px; border-left: 2px solid #f0d080; }

.center-panel { display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-y: auto; }
#serverIndicator { font-size: 1rem; color: #fff; background: #1a7a1a; padding: 8px 16px; font-weight: bold; border-radius: 4px; border: 1px solid #f0d080; margin-bottom: 15px; }

/* ‚îÄ‚îÄ TAPIS ORIGINAL INTACT ‚îÄ‚îÄ */
table.tapis { border-collapse: collapse; border: 2px solid #f0d080; }
table.tapis td { width: 45px; height: 38px; text-align: center; border: 1px solid rgba(240,208,128,0.3); font-size: 0.8rem; font-weight: bold; cursor: pointer; color: #fff; position: relative; touch-action: manipulation; }
table.tapis td.red { background: #c0222a; }
table.tapis td.black { background: #1a1a1a; }
table.tapis td.green0 { background: #1a7a1a; }
table.tapis td.out { background: #083d1a; color: #f0d080; font-size: 0.6rem; }
table.tapis td.has-bet::after { content: attr(data-chip); position: absolute; inset: 0; margin: auto; background: #f0d080; color: #000; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; border: 1px solid #000; }

.bets-under-table { width: 100%; max-width: 600px; margin-top: 20px; background: rgba(0,0,0,0.3); border: 1px solid rgba(240,208,128,0.2); padding: 10px; border-radius: 5px; }
.bets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; margin-top: 10px; max-height: 150px; overflow-y: auto; }
.bet-card { background: rgba(255,255,255,0.05); padding: 6px; border-left: 3px solid #f0d080; font-size: 0.7rem; position: relative; color: #fff; }
.bet-card .rm { position: absolute; right: 5px; top: 2px; color: #ff8080; cursor: pointer; padding: 4px; touch-action: manipulation; }

.right-panel { border-left: 1px solid rgba(240,208,128,0.2); background: rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; }
#chatBox { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.8rem; -webkit-overflow-scrolling: touch; }
.msg { margin-bottom: 5px; line-height: 1.3; word-break: break-word; color: #ddd; }
.msg b { color: #f0d080; }
.chat-input-area { display: flex; padding: 10px; background: rgba(0,0,0,0.3); flex-shrink: 0; }
#chatInput { flex: 1; background: #0a3520; border: 1px solid #f0d080; color: #fff; padding: 8px; outline: none; font-family: monospace; min-width: 0; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE ‚Äî Layout paysage compact
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media (max-width: 899px) {
  #game {
    grid-template-columns: 210px 1fr 190px !important;
    height: calc(100vh - 42px) !important;
  }

  /* Roue r√©duite */
  .left-panel { padding: 5px; }
  .history-item { font-size: 0.58rem; padding: 4px; margin-bottom: 4px; }
  #resultBox { font-size: 0.85rem !important; }

  /* Tapis : cellules r√©duites proportionnellement */
  .center-panel { padding: 5px; overflow-y: auto; }
  #serverIndicator { font-size: 0.7rem; padding: 5px 8px; margin-bottom: 8px; }
  table.tapis td { width: 28px !important; height: 26px !important; font-size: 0.55rem !important; }
  table.tapis td.out { font-size: 0.45rem !important; }
  table.tapis td.has-bet::after { width: 14px; height: 14px; font-size: 0.45rem; }

  .bets-under-table { margin-top: 6px; padding: 5px; }
  .bets-grid { max-height: 65px; gap: 4px; grid-template-columns: repeat(auto-fill, minmax(80px,1fr)); }
  .bet-card { font-size: 0.58rem; padding: 4px; }

  /* Contr√¥les compacts */
  #controlsBar { gap: 6px !important; padding: 7px !important; margin-top: 7px !important; flex-wrap: wrap; }
  #controlsBar input[type=number] { width: 48px !important; padding: 3px !important; font-size: 0.72rem; }
  .gold-btn { padding: 6px 10px !important; font-size: 0.72rem !important; }

  /* Chat compact */
  .right-panel { font-size: 0.7rem; }
  #chatBox { font-size: 0.68rem; padding: 6px; }
  .chat-input-area { padding: 5px; }
  #chatInput { padding: 5px; font-size: 0.7rem; }
  .chat-input-area button { padding: 5px 8px !important; }
}

/* ‚îÄ‚îÄ BANNIERE PORTRAIT ‚îÄ‚îÄ */
#rotatePrompt {
  display: none;
  position: fixed; inset: 0; z-index: 500;
  background: rgba(5,35,15,0.97);
  flex-direction: column; align-items: center; justify-content: center; gap: 20px;
  color: #f0d080; font-family: monospace; text-align: center; padding: 30px;
}
#rotatePrompt .icon { font-size: 3rem; animation: rotHint 1.4s ease-in-out infinite alternate; }
@keyframes rotHint { from { transform: rotate(0deg); } to { transform: rotate(90deg); } }
#rotatePrompt p { font-size: 0.95rem; letter-spacing: 0.12em; line-height: 1.8; }

@media (max-width: 899px) and (orientation: portrait) {
  #rotatePrompt { display: flex; }
}
</style>
</head>
<body>

<h1>ROULETTE MULTIJOUEUR</h1>

<!-- Banniere tourne le telephone -->
<div id="rotatePrompt">
  <div class="icon">üì±</div>
  <p>TOURNE TON TELEPHONE<br>EN MODE PAYSAGE</p>
</div>

<div id="startScreen">
  <h2>BIENVENUE DANS MON CASINO</h2>
  <input type="text" class="start-input" id="playerName" placeholder="Votre Pseudo" maxlength="15" />
  <button class="gold-btn" onclick="startGame()">REJOINDRE LA TABLE (500‚Ç¨)</button>
</div>

<div id="game">
  <div class="left-panel">
    <canvas id="c" width="400" height="400"></canvas>
    <div id="resultBox" style="font-size: 1.2rem; color: #f0d080; font-weight: bold; margin: 10px 0; text-align:center;"></div>
    <div style="width: 100%; border-top: 1px solid rgba(240,208,128,0.3); padding-top: 10px;">
      <p style="color: #f0d080; font-size: 0.8rem; margin-bottom: 10px;">HISTORIQUE DES TOURS</p>
      <div id="historyList"></div>
    </div>
  </div>

  <div class="center-panel">
    <div id="serverIndicator">05:00</div>
    <table class="tapis" id="tableEl"></table>

    <div class="bets-under-table">
      <p style="color: #f0d080; font-size: 0.75rem;">MISES SUR LA TABLE :</p>
      <div id="betsList" class="bets-grid"></div>
    </div>

    <div id="controlsBar" style="margin-top:20px; display:flex; gap:15px; align-items:center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 5px; border: 1px solid rgba(240,208,128,0.1);">
      <div style="color: #f0d080;">Solde: <span id="balEl" style="font-weight:bold; font-size:1.1rem;">500</span>‚Ç¨</div>
      <div style="color: #fff;">Mise: <input type="number" id="miseEl" value="10" min="1" style="width:70px; background: #0a3520; border: 1px solid #f0d080; color: #f0d080; padding: 5px; text-align: center;"></div>
      <button class="gold-btn" id="readyBtn" onclick="confirmReady()">PRET</button>
      <button onclick="clearAllBets()" style="background:none; border: 1px solid #ff8080; color: #ff8080; cursor: pointer; padding: 5px; font-size: 0.7rem; touch-action: manipulation;">EFFACER</button>
    </div>
  </div>

  <div class="right-panel">
    <div style="padding: 8px 10px; border-bottom: 1px solid rgba(240,208,128,0.2); color: #f0d080; font-size: 0.75rem; letter-spacing: 0.1em; flex-shrink:0;">CHAT DE LA TABLE</div>
    <div id="chatBox"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="Message..." maxlength="120">
      <button onclick="sendChat()" style="background:#f0d080; border:none; padding:5px 12px; margin-left:5px; cursor:pointer; font-weight:bold; touch-action:manipulation; flex-shrink:0;">OK</button>
    </div>
  </div>
</div>

<script>
const socket = io();
let myBalance = 500, myBets = [], isReady = false, isSpinning = false;
const REDS = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
const ORDER = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];

// ‚îÄ‚îÄ CANVAS RESPONSIVE ‚îÄ‚îÄ
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let CANVAS_SIZE = 400;

function updateCanvasSize() {
  CANVAS_SIZE = window.innerWidth < 900 ? 200 : 400;
  canvas.width = CANVAS_SIZE;
  canvas.height = CANVAS_SIZE;
  drawRoue(currentAngle);
}
window.addEventListener('resize', () => setTimeout(updateCanvasSize, 100));
window.addEventListener('orientationchange', () => setTimeout(updateCanvasSize, 300));

// ‚îÄ‚îÄ DEMARRAGE ‚îÄ‚îÄ
function startGame() {
  const n = document.getElementById('playerName').value.trim();
  if(!n) return alert("Pseudo requis");
  socket.emit('join', n);
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('game').style.display = 'grid';
  buildTable();
  updateCanvasSize();
  drawRoue(0);
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ
function sendChat() {
  const i = document.getElementById('chatInput');
  if(i.value.trim()) { socket.emit('sendMessage', i.value); i.value = ''; }
}
document.getElementById('chatInput').addEventListener('keypress', e => { if(e.key === 'Enter') sendChat(); });

socket.on('chatMessage', d => {
  const box = document.getElementById('chatBox');
  const div = document.createElement('div');
  div.className = 'msg';
  const b = document.createElement('b');
  b.textContent = d.name + ':';
  div.appendChild(b);
  div.appendChild(document.createTextNode(' ' + d.text));
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
});

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
socket.on('timer', t => {
  const m = Math.floor(t/60), s = t%60;
  document.getElementById('serverIndicator').textContent = (isReady ? "EN ATTENTE - " : "MISES : ") + `${m}:${s.toString().padStart(2,'0')}`;
});

// ‚îÄ‚îÄ MISES GLOBALES ‚îÄ‚îÄ
socket.on('updateGlobalBets', all => {
  const l = document.getElementById('betsList');
  l.innerHTML = '';
  all.forEach(b => {
    const isMe = b.socketId === socket.id;
    const div = document.createElement('div');
    div.className = 'bet-card';
    div.innerHTML = `<b>${esc(b.playerName)}</b><br>${esc(b.label)}<br>${b.amount}‚Ç¨` +
      (isMe && !isReady ? `<span class="rm" onclick="removeBet(${b.betId})">&#10005;</span>` : '');
    l.appendChild(div);
  });
  updateTableChips();
});

// ‚îÄ‚îÄ SPIN ‚îÄ‚îÄ
socket.on('spin', d => {
  isSpinning = true; isReady = false;
  document.getElementById('readyBtn').disabled = true;
  document.getElementById('serverIndicator').textContent = "LES JEUX SONT FAITS";
  document.getElementById('serverIndicator').style.background = "#c0222a";
  animateRoue(d.result, () => { isSpinning = false; displayResults(d.roundResults, d.result); });
});

socket.on('newRound', () => {
  myBets = []; isReady = false;
  document.getElementById('readyBtn').disabled = false;
  document.getElementById('serverIndicator').style.background = "#1a7a1a";
  document.getElementById('resultBox').textContent = "";
  updateTableChips();
});

// ‚îÄ‚îÄ PRET ‚îÄ‚îÄ
function confirmReady() {
  if(myBets.length === 0) return alert("Misez d'abord !");
  isReady = true; document.getElementById('readyBtn').disabled = true;
  socket.emit('playerReady');
}

// ‚îÄ‚îÄ CLIC CELLULE ‚îÄ‚îÄ
function handleCellClick(td) {
  if(isReady || isSpinning) return;
  const val = parseInt(document.getElementById('miseEl').value);
  const total = myBets.reduce((a,b)=>a+b.amount, 0);
  if(val > (myBalance - total)) return;

  const key = td.dataset.key;
  const existing = myBets.find(b => b.tdKey === key);
  if(existing) existing.amount += val;
  else myBets.push({ id: Date.now(), tdKey: key, nums: JSON.parse(td.dataset.nums), payout: parseInt(td.dataset.payout), label: td.dataset.label, amount: val });

  socket.emit('updateBets', myBets);
  updateTableChips();
}

function updateTableChips() {
  document.querySelectorAll('td').forEach(td => { td.classList.remove('has-bet'); td.removeAttribute('data-chip'); });
  myBets.forEach(b => {
    const td = document.querySelector(`td[data-key="${b.tdKey}"]`);
    if(td) { td.classList.add('has-bet'); td.setAttribute('data-chip', b.amount+'‚Ç¨'); }
  });
  document.getElementById('balEl').textContent = myBalance - myBets.reduce((a,b)=>a+b.amount,0);
}

function removeBet(id) {
  myBets = myBets.filter(b => b.id !== id);
  socket.emit('updateBets', myBets);
  updateTableChips();
}

function clearAllBets() { if(!isReady) { myBets = []; socket.emit('updateBets', []); updateTableChips(); } }

// ‚îÄ‚îÄ HISTORIQUE ‚îÄ‚îÄ
function displayResults(results, num) {
  const color = num === 0 ? "VERT" : (REDS.has(num) ? "ROUGE" : "NOIR");
  document.getElementById('resultBox').textContent = `GAGNANT : ${num} ${color}`;
  const hList = document.getElementById('historyList');
  const div = document.createElement('div');
  div.className = 'history-item';
  div.innerHTML = `<b>Tour: ${num} (${color})</b><br>`;
  results.forEach(r => {
    div.innerHTML += `${esc(r.name)}: ${r.net >= 0 ? '+' : ''}${r.net}&#8364;<br>`;
    if(r.socketId === socket.id) { myBalance = r.newBalance; document.getElementById('balEl').textContent = myBalance; }
  });
  hList.insertBefore(div, hList.firstChild);
}

// ‚îÄ‚îÄ TAPIS ORIGINAL INTACT ‚îÄ‚îÄ
function buildTable() {
  const t = document.getElementById('tableEl'); t.innerHTML = "";
  for(let r=0; r<3; r++) {
    const tr = t.insertRow();
    if(r===0) { const z = tr.insertCell(); z.rowSpan=3; z.className="green0"; z.textContent="0"; setupCell(z, "zero", [0], 35, "0"); }
    for(let c=0; c<12; c++) {
      const n = c*3+(3-r); const td = tr.insertCell(); td.textContent=n; td.className=REDS.has(n)?"red":"black";
      setupCell(td, "n"+n, [n], 35, "Plein "+n);
    }
    const colIdx = 3-r; const ctd = tr.insertCell(); ctd.className="out"; ctd.textContent="2to1";
    const cnums = []; for(let i=colIdx; i<=36; i+=3) cnums.push(i);
    setupCell(ctd, "col"+colIdx, cnums, 2, "Colonne "+colIdx);
  }
  const trD = t.insertRow(); trD.insertCell();
  [[1,12,"1st 12"],[13,24,"2nd 12"],[25,36,"3rd 12"]].forEach((d,i)=>{
    const td = trD.insertCell(); td.colSpan=4; td.className="out"; td.textContent=d[2];
    const nums=[]; for(let j=d[0]; j<=d[1]; j++) nums.push(j);
    setupCell(td, "d"+i, nums, 2, d[2]);
  });
  const trS = t.insertRow(); trS.insertCell();
  const simple = [
    {l:"1-18", n:Array.from({length:18},(_,i)=>i+1)},
    {l:"Pair", n:Array.from({length:36},(_,i)=>i+1).filter(x=>x%2===0)},
    {l:"Rouge", n:[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]},
    {l:"Noir", n:[2,4,6,8,10,11,13,15,17,20,22,24,26,28,29,31,33,35]},
    {l:"Impair", n:Array.from({length:36},(_,i)=>i+1).filter(x=>x%2!==0)},
    {l:"19-36", n:Array.from({length:18},(_,i)=>i+19)}
  ];
  simple.forEach(s => {
    const td = trS.insertCell(); td.colSpan=2; td.className="out"; td.textContent=s.l;
    setupCell(td, "s"+s.l, s.n, 1, s.l);
  });
}

function setupCell(td, key, nums, pay, lbl) {
  td.dataset.key=key; td.dataset.nums=JSON.stringify(nums); td.dataset.payout=pay; td.dataset.label=lbl;
  td.onclick = () => handleCellClick(td);
}

// ‚îÄ‚îÄ ROUE ‚îÄ‚îÄ
let currentAngle = 0;

function drawRoue(ang) {
  const S = CANVAS_SIZE;
  const cx = S/2, cy = S/2, r = S/2 - (S < 300 ? 8 : 20);
  ctx.clearRect(0,0,S,S);
  for(let i=0; i<37; i++) {
    const a = ang + (i*2*Math.PI/37);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a,a+(2*Math.PI/37));
    const num = ORDER[i];
    ctx.fillStyle = num===0?"#1a7a1a":(REDS.has(num)?"#c0222a":"#1a1a1a");
    ctx.fill();
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(a + Math.PI/37 + Math.PI/2);
    ctx.fillStyle="white";
    const fs = Math.max(7, Math.floor(S/40));
    ctx.font = fs + "px Arial";
    ctx.fillText(num, -fs/2, -r+fs+6);
    ctx.restore();
  }
  // Marqueur
  ctx.fillStyle="#f0d080";
  ctx.beginPath(); ctx.moveTo(cx, 4); ctx.lineTo(cx-6,-4); ctx.lineTo(cx+6,-4); ctx.fill();
}

function animateRoue(res, cb) {
  const target = ORDER.indexOf(res), duration = 4000, start = performance.now();
  const targetRot = (2*Math.PI*5) + (target * 2*Math.PI/37);
  const initial = currentAngle;
  function step(now) {
    const p = Math.min((now-start)/duration, 1);
    const ease = 1 - Math.pow(1-p, 3);
    currentAngle = initial - (ease * targetRot);
    drawRoue(currentAngle);
    if(p < 1) requestAnimationFrame(step); else cb();
  }
  requestAnimationFrame(step);
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
</script>
</body>
</html>
