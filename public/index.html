<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Roulette EuropÃ©enne Multijoueur</title>
<script src="/socket.io/socket.io.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Share+Tech+Mono&display=swap');

/* â”€â”€ RESET & BASE â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --gold: #f0d080;
  --gold-dim: rgba(240,208,128,0.25);
  --green-dark: #0a5028;
  --green-mid: #0a3520;
  --green-light: #1a7a1a;
  --red: #c0222a;
  --panel-bg: rgba(0,0,0,0.22);
  --border: 1px solid var(--gold-dim);
  --font-mono: 'Share Tech Mono', monospace;
  --font-display: 'Playfair Display', serif;
}
html, body {
  height: 100%; width: 100%;
  background: var(--green-dark);
  font-family: var(--font-mono);
  overflow: hidden;
}

/* â”€â”€ HEADER â”€â”€ */
#header {
  height: 44px;
  display: flex; align-items: center; justify-content: center;
  border-bottom: var(--border);
  background: rgba(0,0,0,0.3);
  flex-shrink: 0;
}
#header h1 {
  font-family: var(--font-display);
  color: var(--gold);
  font-size: clamp(0.85rem, 2.5vw, 1.1rem);
  letter-spacing: 0.2em;
}

/* â”€â”€ START SCREEN â”€â”€ */
#startScreen {
  position: fixed; inset: 0;
  background: rgba(5,35,15,0.97);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 18px; z-index: 200;
  padding: 20px;
}
#startScreen h2 {
  font-family: var(--font-display);
  color: var(--gold);
  font-size: clamp(1.1rem, 5vw, 1.5rem);
  letter-spacing: 0.15em;
  text-align: center;
}
#startScreen p { color: rgba(240,208,128,0.6); font-size: 0.75rem; text-align: center; }
.start-input {
  width: min(240px, 80vw);
  padding: 12px; font-size: 1.1rem;
  font-family: var(--font-mono);
  border: 2px solid var(--gold);
  background: var(--green-mid);
  color: var(--gold); text-align: center; outline: none;
  border-radius: 2px;
}
.gold-btn {
  padding: 12px 36px; font-size: 0.95rem;
  font-family: var(--font-mono);
  background: var(--gold); border: none;
  color: #000; cursor: pointer;
  font-weight: bold; letter-spacing: 0.12em;
  transition: background 0.15s, transform 0.1s;
  border-radius: 2px; touch-action: manipulation;
}
.gold-btn:hover { background: #fff; }
.gold-btn:active { transform: scale(0.97); }
.gold-btn:disabled { opacity: 0.35; cursor: default; }

/* â”€â”€ GAME LAYOUT â”€â”€ */
#game {
  display: none;
  width: 100vw;
  height: calc(100vh - 44px);
  flex-direction: column;
}

/* DESKTOP : 3 colonnes */
@media (min-width: 900px) {
  #game {
    flex-direction: row !important;
    overflow: hidden;
  }
  #tabs { display: none !important; }
  .left-panel, .center-panel, .right-panel { display: flex !important; }
  .left-panel {
    width: 420px; flex-shrink: 0;
    border-right: var(--border);
  }
  .center-panel { flex: 1; }
  .right-panel {
    width: 280px; flex-shrink: 0;
    border-left: var(--border);
  }
}

/* MOBILE : panels cachÃ©s, tabs visibles */
@media (max-width: 899px) {
  #game { flex-direction: column; }
  .left-panel, .center-panel, .right-panel {
    display: none;
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .left-panel.active, .center-panel.active, .right-panel.active { display: flex; }
}

/* â”€â”€ PANELS â”€â”€ */
.left-panel {
  flex-direction: column;
  align-items: center;
  padding: 10px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.center-panel {
  flex-direction: column;
  align-items: center;
  padding: 10px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.right-panel {
  background: var(--panel-bg);
  flex-direction: column;
  overflow: hidden;
}

/* â”€â”€ TABS MOBILE â”€â”€ */
#tabs {
  display: flex;
  flex-shrink: 0;
  border-top: var(--border);
  background: rgba(0,0,0,0.4);
  z-index: 10;
  order: 99;
}
.tab-btn {
  flex: 1; padding: 12px 0;
  font-family: var(--font-mono);
  font-size: 0.7rem; letter-spacing: 0.1em;
  background: none; border: none;
  color: rgba(240,208,128,0.5);
  cursor: pointer; transition: color 0.2s, background 0.2s;
  touch-action: manipulation;
}
.tab-btn.active {
  color: var(--gold);
  background: rgba(240,208,128,0.08);
  border-top: 2px solid var(--gold);
}

/* â”€â”€ STATUS BAR â”€â”€ */
#serverIndicator {
  font-size: 0.9rem; color: #fff;
  background: var(--green-light);
  padding: 8px 16px; font-weight: bold;
  border-radius: 3px; text-align: center;
  border: var(--border); margin-bottom: 12px;
  width: 100%; max-width: 600px;
  letter-spacing: 0.05em;
  transition: background 0.3s;
}

/* â”€â”€ CANVAS â”€â”€ */
canvas {
  display: block;
  margin-bottom: 10px;
  max-width: 100%;
  height: auto;
}

/* â”€â”€ RESULT BOX â”€â”€ */
#resultBox {
  font-size: 1.1rem; color: var(--gold);
  font-weight: bold; margin-bottom: 12px;
  min-height: 28px; text-align: center;
  letter-spacing: 0.1em;
}

/* â”€â”€ HISTORIQUE â”€â”€ */
#historyList { width: 100%; }
.history-section-title {
  color: var(--gold); font-size: 0.75rem;
  letter-spacing: 0.12em; margin-bottom: 8px;
  border-bottom: var(--border); padding-bottom: 4px;
}
.history-item {
  background: var(--panel-bg);
  border: var(--border); border-left: 3px solid var(--gold);
  margin-bottom: 8px; padding: 8px;
  font-size: 0.72rem; border-radius: 3px; color: #ddd;
}
.history-item b { color: var(--gold); }

/* â”€â”€ TAPIS â”€â”€ */
.tapis-wrapper {
  width: 100%; max-width: 600px;
  overflow-x: auto; -webkit-overflow-scrolling: touch;
  border-radius: 2px;
}
table.tapis { border-collapse: collapse; border: 2px solid var(--gold); }
table.tapis td {
  width: 42px; height: 38px; text-align: center;
  border: 1px solid var(--gold-dim);
  font-size: 0.8rem; font-weight: bold;
  cursor: pointer; color: #fff; position: relative;
  user-select: none; -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: filter 0.1s;
}
table.tapis td:active { filter: brightness(1.4); }
table.tapis td.red { background: var(--red); }
table.tapis td.black { background: #1a1a1a; }
table.tapis td.green0 { background: var(--green-light); }
table.tapis td.has-bet::after {
  content: attr(data-chip);
  position: absolute; inset: 0; margin: auto;
  background: var(--gold); color: #000;
  border-radius: 50%; width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.6rem; border: 1px solid #000;
  font-weight: bold; pointer-events: none;
}

/* â”€â”€ MISES â”€â”€ */
.bets-under-table {
  width: 100%; max-width: 600px;
  margin-top: 16px;
  background: var(--panel-bg);
  border: var(--border); padding: 10px; border-radius: 4px;
}
.bets-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 8px; margin-top: 10px;
  max-height: 150px; overflow-y: auto;
}
.bet-card {
  background: rgba(255,255,255,0.05);
  padding: 7px; border-left: 3px solid var(--gold);
  font-size: 0.68rem; position: relative; color: #fff;
  border-radius: 2px;
}
.bet-card .rm {
  position: absolute; right: 6px; top: 3px;
  color: #ff8080; cursor: pointer;
  font-weight: bold; font-size: 0.85rem;
  touch-action: manipulation; padding: 4px;
}

/* â”€â”€ CONTROLES â”€â”€ */
.controls-bar {
  margin-top: 16px; width: 100%; max-width: 600px;
  display: flex; flex-wrap: wrap;
  gap: 10px; align-items: center;
  background: var(--panel-bg);
  padding: 12px; border-radius: 4px;
  border: var(--border);
}
.balance-label { color: var(--gold); white-space: nowrap; }
.balance-label span { font-weight: bold; font-size: 1.05rem; }
.mise-label { color: #fff; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
.mise-label input {
  width: 65px;
  background: var(--green-mid);
  border: 1px solid var(--gold);
  color: var(--gold); padding: 6px;
  text-align: center; font-family: var(--font-mono);
  font-size: 0.9rem; border-radius: 2px;
  -webkit-appearance: none;
}
.clear-btn {
  background: none; border: 1px solid #ff8080;
  color: #ff8080; cursor: pointer; padding: 8px 14px;
  font-family: var(--font-mono); font-size: 0.7rem;
  border-radius: 2px; touch-action: manipulation;
  transition: background 0.15s;
}
.clear-btn:active { background: rgba(255,128,128,0.15); }

/* â”€â”€ QUICK BET CHIPS â”€â”€ */
.chip-row {
  display: flex; gap: 6px; width: 100%; flex-wrap: wrap; margin-top: 4px;
}
.chip {
  padding: 6px 10px; border-radius: 50px;
  font-family: var(--font-mono); font-size: 0.72rem;
  cursor: pointer; border: 2px solid;
  font-weight: bold; touch-action: manipulation;
  transition: transform 0.1s, opacity 0.1s;
  -webkit-tap-highlight-color: transparent;
}
.chip:active { transform: scale(0.93); }
.chip-1   { background: #e8e8e8; border-color: #aaa; color: #222; }
.chip-5   { background: #c0222a; border-color: #ff6666; color: #fff; }
.chip-10  { background: #1a4a8a; border-color: #6699cc; color: #fff; }
.chip-25  { background: #1a7a1a; border-color: #66cc66; color: #fff; }
.chip-50  { background: #8a1a8a; border-color: #cc66cc; color: #fff; }
.chip-100 { background: #1a1a1a; border-color: var(--gold); color: var(--gold); }

/* â”€â”€ CHAT â”€â”€ */
#chatBox {
  flex: 1; overflow-y: auto; padding: 10px;
  font-size: 0.78rem; color: #ddd;
  -webkit-overflow-scrolling: touch;
}
.chat-header {
  padding: 10px; border-bottom: var(--border);
  text-align: center; color: var(--gold);
  font-size: 0.78rem; letter-spacing: 0.1em;
  flex-shrink: 0;
}
.msg { margin-bottom: 6px; line-height: 1.4; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.04); }
.msg b { color: var(--gold); }
.msg.sys { color: rgba(240,208,128,0.5); font-style: italic; }
.chat-input-area {
  display: flex; padding: 8px;
  background: rgba(0,0,0,0.35); flex-shrink: 0;
  gap: 6px;
}
#chatInput {
  flex: 1; background: var(--green-mid);
  border: 1px solid var(--gold); color: #fff;
  padding: 10px; outline: none;
  font-family: var(--font-mono); font-size: 0.85rem;
  border-radius: 2px;
}
#chatSendBtn {
  background: var(--gold); border: none;
  padding: 0 16px; cursor: pointer;
  font-weight: bold; font-size: 0.9rem;
  border-radius: 2px; touch-action: manipulation;
  flex-shrink: 0;
}
</style>
</head>
<body>

<div id="header"><h1>ðŸŽ° ROULETTE MULTIJOUEUR</h1></div>

<!-- Ã‰CRAN DE DÃ‰MARRAGE -->
<div id="startScreen">
  <h2>BIENVENUE AU CASINO</h2>
  <p>Chaque joueur dÃ©marre avec 500â‚¬</p>
  <input type="text" class="start-input" id="playerName" placeholder="Votre Pseudo" maxlength="15" />
  <button class="gold-btn" onclick="startGame()">REJOINDRE LA TABLE</button>
</div>

<!-- JEU -->
<div id="game">

  <!-- GAUCHE : Roue + Historique -->
  <div class="left-panel" id="panelRoue">
    <canvas id="c"></canvas>
    <div id="resultBox"></div>
    <div style="width:100%; border-top: var(--border); padding-top: 10px;">
      <p class="history-section-title">HISTORIQUE DES TOURS</p>
      <div id="historyList"></div>
    </div>
  </div>

  <!-- CENTRE : Tapis + Mises + ContrÃ´les -->
  <div class="center-panel" id="panelTapis">
    <div id="serverIndicator">05:00</div>

    <div class="tapis-wrapper">
      <table class="tapis" id="tableEl"></table>
    </div>

    <!-- Chips rapides -->
    <div style="width:100%;max-width:600px;margin-top:10px;">
      <div class="chip-row" id="chipRow">
        <span class="chip chip-1"   onclick="setMise(1)">1â‚¬</span>
        <span class="chip chip-5"   onclick="setMise(5)">5â‚¬</span>
        <span class="chip chip-10"  onclick="setMise(10)">10â‚¬</span>
        <span class="chip chip-25"  onclick="setMise(25)">25â‚¬</span>
        <span class="chip chip-50"  onclick="setMise(50)">50â‚¬</span>
        <span class="chip chip-100" onclick="setMise(100)">100â‚¬</span>
      </div>
    </div>

    <div class="bets-under-table">
      <p style="color:var(--gold);font-size:0.75rem;letter-spacing:0.1em;">MISES EN COURS :</p>
      <div id="betsList" class="bets-grid"></div>
    </div>

    <div class="controls-bar">
      <div class="balance-label">Solde : <span id="balEl">500</span>â‚¬</div>
      <div class="mise-label">
        Mise :
        <input type="number" id="miseEl" value="10" min="1">
      </div>
      <button class="gold-btn" id="readyBtn" onclick="confirmReady()">âœ” PRÃŠT</button>
      <button class="clear-btn" onclick="clearAllBets()">âœ• EFFACER</button>
    </div>
  </div>

  <!-- DROITE : Chat -->
  <div class="right-panel" id="panelChat">
    <div class="chat-header">CHAT DE LA TABLE</div>
    <div id="chatBox"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="Message..." maxlength="120">
      <button id="chatSendBtn" onclick="sendChat()">â–¶</button>
    </div>
  </div>

  <!-- TABS MOBILE -->
  <div id="tabs">
    <button class="tab-btn" onclick="switchTab('Roue')">ðŸŽ¡ ROUE</button>
    <button class="tab-btn active" onclick="switchTab('Tapis')">ðŸŽ² TAPIS</button>
    <button class="tab-btn" onclick="switchTab('Chat')" id="chatTabBtn">ðŸ’¬ CHAT</button>
  </div>

</div><!-- end #game -->

<script>
const socket = io();
let myBalance = 500;
let myBets = [];
let isReady = false;
let isSpinning = false;
const REDS = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
const ORDER = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
let unreadChat = 0;

// â”€â”€ TABS MOBILE â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');
  document.getElementById('panelRoue').classList.remove('active');
  document.getElementById('panelTapis').classList.remove('active');
  document.getElementById('panelChat').classList.remove('active');
  if(name === 'Roue')  document.getElementById('panelRoue').classList.add('active');
  if(name === 'Tapis') document.getElementById('panelTapis').classList.add('active');
  if(name === 'Chat')  {
    document.getElementById('panelChat').classList.add('active');
    unreadChat = 0;
    document.getElementById('chatTabBtn').textContent = 'ðŸ’¬ CHAT';
    setTimeout(() => {
      const box = document.getElementById('chatBox');
      box.scrollTop = box.scrollHeight;
    }, 50);
  }
}

function initTabs() {
  if(window.innerWidth < 900) {
    document.getElementById('panelTapis').classList.add('active');
  }
}

// â”€â”€ CANVAS RESPONSIVE â”€â”€
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let CANVAS_SIZE = 380;

function updateCanvasSize() {
  const maxW = Math.min(window.innerWidth - 20, 400);
  CANVAS_SIZE = maxW;
  canvas.width = CANVAS_SIZE;
  canvas.height = CANVAS_SIZE;
  drawRoue(currentAngle);
}

window.addEventListener('resize', updateCanvasSize);

// â”€â”€ START â”€â”€
function startGame() {
  const name = document.getElementById('playerName').value.trim();
  if(!name) return alert("Pseudo requis");
  socket.emit('join', name);
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('game').style.display = 'flex';
  updateCanvasSize();
  buildTable();
  initTabs();
}

// â”€â”€ MISE RAPIDE â”€â”€
function setMise(val) {
  document.getElementById('miseEl').value = val;
}

// â”€â”€ CHAT â”€â”€
function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(text) { socket.emit('sendMessage', text); input.value = ''; }
}
document.getElementById('chatInput').addEventListener('keypress', e => {
  if(e.key === 'Enter') sendChat();
});

socket.on('chatMessage', data => {
  const box = document.getElementById('chatBox');
  const div = document.createElement('div');
  div.className = 'msg';
  div.innerHTML = `<b>${escHtml(data.name)}:</b> ${escHtml(data.text)}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;

  // Badge non-lus sur mobile
  const chatPanel = document.getElementById('panelChat');
  if(window.innerWidth < 900 && !chatPanel.classList.contains('active')) {
    unreadChat++;
    document.getElementById('chatTabBtn').textContent = `ðŸ’¬ (${unreadChat})`;
  }
});

// â”€â”€ TIMER â”€â”€
socket.on('timer', (t) => {
  const min = Math.floor(t/60), sec = t%60;
  const timeStr = `${min}:${sec.toString().padStart(2,'0')}`;
  document.getElementById('serverIndicator').textContent = (isReady ? "â³ EN ATTENTE â€” " : "ðŸŽ² MISES : ") + timeStr;
});

// â”€â”€ MISES GLOBALES â”€â”€
socket.on('updateGlobalBets', (all) => {
  const list = document.getElementById('betsList');
  list.innerHTML = '';
  all.forEach(b => {
    const isMe = b.socketId === socket.id;
    const div = document.createElement('div');
    div.className = 'bet-card';
    div.innerHTML = `<b>${escHtml(b.playerName)}</b><br>${escHtml(b.label)}<br>${b.amount}â‚¬` +
      (isMe && !isReady ? `<span class="rm" onclick="removeBet(${b.betId})">âœ•</span>` : '');
    list.appendChild(div);
  });
  updateTableChips();
});

// â”€â”€ SPIN â”€â”€
socket.on('spin', data => {
  isSpinning = true; isReady = false;
  document.getElementById('readyBtn').disabled = true;
  const ind = document.getElementById('serverIndicator');
  ind.textContent = "ðŸš« LES JEUX SONT FAITS";
  ind.style.background = 'var(--red)';

  // Basculer sur la roue en mobile
  if(window.innerWidth < 900) {
    document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', i===0));
    document.getElementById('panelTapis').classList.remove('active');
    document.getElementById('panelChat').classList.remove('active');
    document.getElementById('panelRoue').classList.add('active');
  }

  animateRoue(data.result, () => {
    isSpinning = false;
    displayResults(data.roundResults, data.result);
  });
});

socket.on('newRound', () => {
  myBets = []; isReady = false;
  document.getElementById('readyBtn').disabled = false;
  const ind = document.getElementById('serverIndicator');
  ind.style.background = 'var(--green-light)';
  document.getElementById('resultBox').textContent = "";
  updateTableChips();
});

// â”€â”€ PRÃŠT â”€â”€
function confirmReady() {
  if(myBets.length === 0) return alert("Placez une mise avant d'Ãªtre prÃªt !");
  isReady = true;
  document.getElementById('readyBtn').disabled = true;
  socket.emit('playerReady');
}

// â”€â”€ CLIC SUR CELLULE â”€â”€
function handleCellClick(td) {
  if(isReady || isSpinning) return;
  const val = parseInt(document.getElementById('miseEl').value) || 10;
  const total = myBets.reduce((a,b) => a+b.amount, 0);
  if(val > (myBalance - total)) return alert("Solde insuffisant !");

  const key = td.dataset.key;
  const existing = myBets.find(b => b.tdKey === key);
  if(existing) existing.amount += val;
  else myBets.push({
    id: Date.now(), tdKey: key,
    nums: JSON.parse(td.dataset.nums),
    payout: parseInt(td.dataset.payout),
    label: td.dataset.label,
    amount: val
  });

  socket.emit('updateBets', myBets);
  updateTableChips();
}

function updateTableChips() {
  document.querySelectorAll('td[data-key]').forEach(td => {
    td.classList.remove('has-bet');
    td.removeAttribute('data-chip');
  });
  myBets.forEach(b => {
    const td = document.querySelector(`td[data-key="${b.tdKey}"]`);
    if(td) { td.classList.add('has-bet'); td.setAttribute('data-chip', b.amount+'â‚¬'); }
  });
  const engaged = myBets.reduce((a,b) => a+b.amount, 0);
  document.getElementById('balEl').textContent = myBalance - engaged;
}

function removeBet(id) {
  myBets = myBets.filter(b => b.id !== id);
  socket.emit('updateBets', []);
  updateTableChips();
}

function clearAllBets() {
  if(!isReady) { myBets = []; socket.emit('updateBets', []); updateTableChips(); }
}

// â”€â”€ RÃ‰SULTATS â”€â”€
function displayResults(results, num) {
  const color = num === 0 ? "VERT" : (REDS.has(num) ? "ROUGE" : "NOIR");
  document.getElementById('resultBox').textContent = `Gagnant : ${num} â€” ${color}`;

  const hList = document.getElementById('historyList');
  const div = document.createElement('div');
  div.className = 'history-item';
  div.innerHTML = `<b>${num} (${color})</b><br>`;
  results.forEach(r => {
    div.innerHTML += `${escHtml(r.name)}: ${r.net >= 0 ? '+' : ''}${r.net}â‚¬ â†’ <b>${r.newBalance}â‚¬</b><br>`;
    if(r.socketId === socket.id) {
      myBalance = r.newBalance;
      document.getElementById('balEl').textContent = myBalance;
    }
  });
  hList.insertBefore(div, hList.firstChild);

  addSysChat(`RÃ©sultat : ${num} (${color})`);
}

function addSysChat(text) {
  const box = document.getElementById('chatBox');
  const div = document.createElement('div');
  div.className = 'msg sys';
  div.textContent = text;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// â”€â”€ TAPIS â”€â”€
function buildTable() {
  const t = document.getElementById('tableEl'); t.innerHTML = "";
  for(let r=0; r<3; r++) {
    const tr = t.insertRow();
    if(r===0) {
      const z = tr.insertCell(); z.rowSpan=3; z.className="green0"; z.textContent="0";
      setupCell(z, "zero", [0], 35, "Plein 0");
    }
    for(let c=0; c<12; c++) {
      const n = c*3+(3-r);
      const td = tr.insertCell(); td.textContent=n;
      td.className = REDS.has(n) ? "red" : "black";
      setupCell(td, "n"+n, [n], 35, "Plein "+n);
    }
  }
}
function setupCell(td, key, nums, pay, lbl) {
  td.dataset.key = key;
  td.dataset.nums = JSON.stringify(nums);
  td.dataset.payout = pay;
  td.dataset.label = lbl;
  td.onclick = () => handleCellClick(td);
}

// â”€â”€ ROUE â”€â”€
let currentAngle = 0;

function drawRoue(ang) {
  const S = CANVAS_SIZE || 380;
  const cx = S/2, cy = S/2, r = S/2 - 10;
  ctx.clearRect(0, 0, S, S);

  for(let i=0; i<37; i++) {
    const a = ang + (i * 2*Math.PI/37);
    ctx.beginPath(); ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, a, a + (2*Math.PI/37));
    const num = ORDER[i];
    ctx.fillStyle = num===0 ? "#1a7a1a" : (REDS.has(num) ? "#c0222a" : "#1a1a1a");
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 0.5;
    ctx.stroke();

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(a + Math.PI/37 + Math.PI/2);
    ctx.fillStyle = "#fff";
    const fontSize = Math.max(8, Math.floor(S/38));
    ctx.font = `${fontSize}px 'Share Tech Mono', monospace`;
    ctx.fillText(num, -fontSize/2, -r + fontSize + 8);
    ctx.restore();
  }

  // Centre
  ctx.beginPath(); ctx.arc(cx, cy, S/12, 0, 2*Math.PI);
  ctx.fillStyle = "#0a3520"; ctx.fill();
  ctx.strokeStyle = "rgba(240,208,128,0.5)"; ctx.lineWidth = 1.5;
  ctx.stroke();

  // Marqueur
  ctx.fillStyle = "#f0d080";
  ctx.beginPath();
  ctx.moveTo(cx, 6); ctx.lineTo(cx - 7, -4); ctx.lineTo(cx + 7, -4);
  ctx.fill();
}

function animateRoue(res, cb) {
  const target = ORDER.indexOf(res);
  const duration = 5000;
  const start = performance.now();
  const targetRot = (2*Math.PI*5) + (target * 2*Math.PI/37);
  const initial = currentAngle;

  function step(now) {
    const progress = Math.min((now - start) / duration, 1);
    const ease = 1 - Math.pow(1 - progress, 3);
    currentAngle = initial - (ease * targetRot);
    drawRoue(currentAngle);
    if(progress < 1) requestAnimationFrame(step);
    else cb();
  }
  requestAnimationFrame(step);
}

// â”€â”€ UTILS â”€â”€
function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
</script>
</body>
</html>
